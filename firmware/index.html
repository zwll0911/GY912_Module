<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>NAV FLIGHT RECORDER</title>
    <script src="chart.js"></script>
    <style>
        body {
            margin: 0;
            background: #121212;
            color: #00ff41;
            font-family: 'Segoe UI', monospace;
            overflow-y: auto;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background: #121212;
            z-index: 100;
        }

        /* BUTTONS */
        .btn-group {
            display: flex;
            gap: 10px;
        }

        button {
            background: #222;
            color: #fff;
            border: 1px solid #555;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.2s;
            font-family: monospace;
        }

        button:hover {
            background: #444;
        }

        #btnConn:hover {
            background: #00ff41;
            color: #000;
        }

        /* RECORDER BUTTON STYLES */
        #btnRec {
            color: #ff5252;
            border-color: #ff5252;
        }

        #btnRec.recording {
            background: #ff5252;
            color: #000;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* DASHBOARD GRID */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
        }

        /* PANELS */
        .panel {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .panel-head {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #333;
            margin-bottom: 15px;
            padding-bottom: 5px;
            color: #888;
            font-size: 14px;
            font-weight: bold;
        }

        .vals {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .v-box {
            background: #000;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }

        .lbl {
            font-size: 11px;
            color: #666;
            display: block;
            margin-bottom: 2px;
        }

        .num {
            font-size: 20px;
            font-weight: bold;
        }

        .chart-box {
            height: 250px;
            width: 100%;
            position: relative;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* COLORS */
        .c-acc {
            color: #ff5252;
        }

        .b-acc {
            border-top: 4px solid #ff5252;
        }

        .c-gyr {
            color: #448aff;
        }

        .b-gyr {
            border-top: 4px solid #448aff;
        }

        .c-mag {
            color: #ffd740;
        }

        .b-mag {
            border-top: 4px solid #ffd740;
        }

        .c-bar {
            color: #69f0ae;
        }

        .b-bar {
            border-top: 4px solid #69f0ae;
        }

        .connected {
            color: #00ff41 !important;
            text-shadow: 0 0 10px #00ff41;
        }

        /* 3D ORIENTATION */
        .orient-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            padding: 10px 0;
        }

        .scene {
            width: 160px;
            height: 160px;
            perspective: 500px;
        }

        .cube {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.08s ease-out;
        }

        .face {
            position: absolute;
            width: 160px;
            height: 160px;
            border: 1px solid rgba(0, 255, 65, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            opacity: 0.85;
            backface-visibility: visible;
        }

        .face.front {
            background: rgba(0, 255, 65, 0.15);
            transform: translateZ(80px);
            color: #00ff41;
        }

        .face.back {
            background: rgba(255, 82, 82, 0.15);
            transform: rotateY(180deg) translateZ(80px);
            color: #ff5252;
        }

        .face.right {
            background: rgba(68, 138, 255, 0.15);
            transform: rotateY(90deg) translateZ(80px);
            color: #448aff;
        }

        .face.left {
            background: rgba(68, 138, 255, 0.15);
            transform: rotateY(-90deg) translateZ(80px);
            color: #448aff;
        }

        .face.top {
            background: rgba(255, 215, 64, 0.15);
            transform: rotateX(90deg) translateZ(80px);
            color: #ffd740;
        }

        .face.bottom {
            background: rgba(255, 215, 64, 0.15);
            transform: rotateX(-90deg) translateZ(80px);
            color: #ffd740;
        }

        .orient-vals {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .orient-val {
            background: #000;
            padding: 10px 25px;
            border-radius: 4px;
            text-align: center;
            min-width: 120px;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header">
            <div>
                <h2 style="margin:0">NAV MISSION CONTROL</h2>
                <div id="status" style="color:#666; font-size:12px; margin-top:5px">SYSTEM OFFLINE</div>
            </div>

            <div style="text-align:center">
                <span style="color:#888; font-size:12px">CORE TEMP</span><br>
                <span id="v_temp" style="font-size:28px; font-weight:bold; color:#fff">--.-</span> <span
                    style="color:#666">Â°C</span>
            </div>

            <div class="btn-group">
                <button id="btnRec" disabled>ðŸ”´ REC</button>
                <button id="btnConn">ðŸ”Œ CONNECT</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="panel b-acc">
                <div class="panel-head"><span class="c-acc">ACCELEROMETER</span> <span>m/sÂ²</span></div>
                <div class="vals">
                    <div class="v-box"><span class="lbl">AX (SURGE)</span><span class="num c-acc" id="v_ax">0.00</span>
                    </div>
                    <div class="v-box"><span class="lbl">AY (SWAY)</span><span class="num c-acc" id="v_ay">0.00</span>
                    </div>
                    <div class="v-box"><span class="lbl">AZ (HEAVE)</span><span class="num c-acc" id="v_az">0.00</span>
                    </div>
                </div>
                <div class="chart-box"><canvas id="cAcc"></canvas></div>
            </div>

            <div class="panel b-gyr">
                <div class="panel-head"><span class="c-gyr">GYROSCOPE</span> <span>deg/s</span></div>
                <div class="vals">
                    <div class="v-box"><span class="lbl">GX (ROLL)</span><span class="num c-gyr" id="v_gx">0.00</span>
                    </div>
                    <div class="v-box"><span class="lbl">GY (PITCH)</span><span class="num c-gyr" id="v_gy">0.00</span>
                    </div>
                    <div class="v-box"><span class="lbl">GZ (YAW)</span><span class="num c-gyr" id="v_gz">0.00</span>
                    </div>
                </div>
                <div class="chart-box"><canvas id="cGyr"></canvas></div>
            </div>

            <div class="panel b-mag">
                <div class="panel-head"><span class="c-mag">MAGNETOMETER</span> <span>uT</span></div>
                <div class="vals">
                    <div class="v-box"><span class="lbl">MX (NORTH)</span><span class="num c-mag" id="v_mx">0.00</span>
                    </div>
                    <div class="v-box"><span class="lbl">MY (EAST)</span><span class="num c-mag" id="v_my">0.00</span>
                    </div>
                    <div class="v-box"><span class="lbl">MZ (DOWN)</span><span class="num c-mag" id="v_mz">0.00</span>
                    </div>
                </div>
                <div class="chart-box"><canvas id="cMag"></canvas></div>
            </div>

            <div class="panel b-bar">
                <div class="panel-head"><span class="c-bar">ALTIMETER</span> <span>m / hPa</span></div>
                <div class="vals" style="grid-template-columns: 1fr 1fr;">
                    <div class="v-box"><span class="lbl">ALTITUDE</span><span class="num c-bar" id="v_alt">0.00</span>
                        <span style="font-size:12px; color:#555">m</span></div>
                    <div class="v-box"><span class="lbl">PRESSURE</span><span class="num c-bar" id="v_press">0.00</span>
                        <span style="font-size:12px; color:#555">hPa</span></div>
                </div>
                <div class="chart-box"><canvas id="cBar"></canvas></div>
            </div>

            <div class="panel" style="border-top: 4px solid #00ff41; grid-column: 1 / -1;">
                <div class="panel-head"><span style="color:#00ff41">3D ORIENTATION</span> <span>Pitch / Roll /
                        Yaw</span></div>
                <div class="orient-container">
                    <div class="scene">
                        <div class="cube" id="cube3d">
                            <div class="face front">FRONT</div>
                            <div class="face back">BACK</div>
                            <div class="face right">RIGHT</div>
                            <div class="face left">LEFT</div>
                            <div class="face top">TOP</div>
                            <div class="face bottom">BOT</div>
                        </div>
                    </div>
                    <div class="orient-vals">
                        <div class="orient-val"><span class="lbl">PITCH</span><span class="num" id="v_pitch"
                                style="color:#ff5252">0.0Â°</span></div>
                        <div class="orient-val"><span class="lbl">ROLL</span><span class="num" id="v_roll"
                                style="color:#448aff">0.0Â°</span></div>
                        <div class="orient-val"><span class="lbl">YAW / HEADING</span><span class="num" id="v_yaw"
                                style="color:#ffd740">0.0Â°</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div style="text-align:center; color:#444; margin-top:30px; padding-bottom:20px; font-size:12px;">
            INDUSTRIAL NAV MODULE V2.1 â€¢ FLIGHT RECORDER ENABLED
        </div>
    </div>

    <script>
        const MAX = 100;
        const dAcc = { x: new Array(MAX).fill(0), y: new Array(MAX).fill(0), z: new Array(MAX).fill(0) };
        const dGyr = { x: new Array(MAX).fill(0), y: new Array(MAX).fill(0), z: new Array(MAX).fill(0) };
        const dMag = { x: new Array(MAX).fill(0), y: new Array(MAX).fill(0), z: new Array(MAX).fill(0) };
        const dBar = { x: new Array(MAX).fill(0), y: new Array(MAX).fill(0) }; // x=Alt, y=Press

        // --- RECORDER VARS ---
        let isRecording = false;
        let flightLog = [];
        const btnRec = document.getElementById('btnRec');

        // Chart Settings
        Chart.defaults.borderColor = '#333';
        Chart.defaults.color = '#666';
        const cOpts = {
            responsive: true, maintainAspectRatio: false, animation: false,
            elements: { point: { radius: 0 }, line: { borderWidth: 2, tension: 0.1 } },
            scales: { x: { display: false }, y: { grid: { color: '#222' }, ticks: { color: '#555' } } },
            plugins: { legend: { display: false } }
        };

        function mkChart(ctx, dObj, c1, c2, c3) {
            let sets = [{ borderColor: c1, data: dObj.x }, { borderColor: c2, data: dObj.y }];
            if (c3) sets.push({ borderColor: c3, data: dObj.z });
            return new Chart(ctx, { type: 'line', options: cOpts, data: { labels: new Array(MAX).fill(0), datasets: sets } });
        }

        const cA = mkChart(document.getElementById('cAcc'), dAcc, '#ff5252', '#ff8a80', '#b71c1c');
        const cG = mkChart(document.getElementById('cGyr'), dGyr, '#448aff', '#82b1ff', '#2962ff');
        const cM = mkChart(document.getElementById('cMag'), dMag, '#ffd740', '#ffe57f', '#ff6f00');
        const cB = mkChart(document.getElementById('cBar'), dBar, '#69f0ae', '#004d40');

        function update() {
            if (conn) {
                set('v_ax', dAcc.x); set('v_ay', dAcc.y); set('v_az', dAcc.z);
                set('v_gx', dGyr.x); set('v_gy', dGyr.y); set('v_gz', dGyr.z);
                set('v_mx', dMag.x); set('v_my', dMag.y); set('v_mz', dMag.z);
                set('v_alt', dBar.x); set('v_press', dBar.y);
                cA.update(); cG.update(); cM.update(); cB.update();

                // 3D Orientation from Accel (Pitch/Roll) + Mag (Yaw)
                let ax = dAcc.x[MAX - 1], ay = dAcc.y[MAX - 1], az = dAcc.z[MAX - 1];
                let mx = dMag.x[MAX - 1], my = dMag.y[MAX - 1];
                let pitch = Math.atan2(-ax, Math.sqrt(ay * ay + az * az)) * 180 / Math.PI;
                let roll = Math.atan2(ay, az) * 180 / Math.PI;
                let yaw = Math.atan2(my, mx) * 180 / Math.PI;
                document.getElementById('cube3d').style.transform = `rotateX(${pitch}deg) rotateZ(${roll}deg) rotateY(${yaw}deg)`;
                document.getElementById('v_pitch').innerText = pitch.toFixed(1) + 'Â°';
                document.getElementById('v_roll').innerText = roll.toFixed(1) + 'Â°';
                document.getElementById('v_yaw').innerText = yaw.toFixed(1) + 'Â°';
            }
            requestAnimationFrame(update);
        }
        function set(id, arr) { document.getElementById(id).innerText = arr[MAX - 1].toFixed(2); }

        let reader, conn = false;

        // --- CONNECT BUTTON ---
        document.getElementById('btnConn').onclick = async () => {
            try {
                const p = await navigator.serial.requestPort();
                await p.open({ baudRate: 115200 });
                document.getElementById('status').innerText = "SYSTEM ONLINE â€¢ READY";
                document.getElementById('status').classList.add('connected');
                document.getElementById('btnConn').style.display = 'none';
                btnRec.disabled = false; // Enable Record button
                conn = true;
                const d = new TextDecoderStream(); p.readable.pipeTo(d.writable);
                reader = d.readable.getReader();
                update(); read();
            } catch (e) { alert("Error: " + e); }
        };

        // --- RECORD BUTTON ---
        btnRec.onclick = () => {
            if (!isRecording) {
                // START RECORDING
                isRecording = true;
                flightLog = ["Timestamp,Ax,Ay,Az,Gx,Gy,Gz,Mx,My,Mz,Temp,Press,Alt"]; // Reset & Add Header
                btnRec.innerHTML = "â¬› STOP";
                btnRec.classList.add('recording');
            } else {
                // STOP & SAVE
                isRecording = false;
                btnRec.innerHTML = "ðŸ”´ REC";
                btnRec.classList.remove('recording');
                saveCSV();
            }
        };

        function saveCSV() {
            if (flightLog.length < 2) return; // No data
            const blob = new Blob([flightLog.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            a.href = url;
            a.download = `flight_log_${timestamp}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        async function read() {
            let b = "";
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                b += value;
                let lines = b.split('\n');
                b = lines.pop();
                for (let l of lines) parse(l.trim());
            }
        }

        function parse(l) {
            let p = l.split(',');
            if (p.length < 12) return;

            // Push to Arrays for Graph
            push(dAcc.x, p[0]); push(dAcc.y, p[1]); push(dAcc.z, p[2]);
            push(dGyr.x, p[3]); push(dGyr.y, p[4]); push(dGyr.z, p[5]);
            push(dMag.x, p[6]); push(dMag.y, p[7]); push(dMag.z, p[8]);
            document.getElementById('v_temp').innerText = parseFloat(p[9]).toFixed(1);
            push(dBar.y, p[10]);
            push(dBar.x, p[11]);

            // LOG TO MEMORY IF RECORDING
            if (isRecording) {
                let now = new Date().toISOString();
                flightLog.push(`${now},${l}`);
            }
        }
        function push(a, v) { a.shift(); a.push(parseFloat(v)); }
    </script>
</body>

</html>